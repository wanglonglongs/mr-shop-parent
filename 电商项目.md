

# 										 电商项目的搭建

​																																															总结篇

## 一、电商框架的搭建与分析

​		1,新建maven项目 mingrui-shop-parent 父级模块(父级模块的作用是为了更好的管理子模块,同时子模块也可以调用父类模块的功能)。

​		2,父级模块下新建model mingrui-shop-basics (子级基础模块) 

​			`该模块中提供基础功能：eureka-service(注册服务),zull(路由，网关)`

​		3,父级模块下新建model mingrui-shop-commoms(子级工具类模块)

​			`该模块提供工具类，封装好的工具类都在此模块中`

​		4,父级模块下新建model mingrui-shop-service(子级服务系统模块)

​			`该模块下是接`
`口 实现类（业务逻辑代码）`

​		5，父级模块下新建model mingrui-shop-service-api(子级服务核心模块)

​			`用来写接口（即规范）`

架构的技术与优点分析：

### 		parent父级模块中pom依赖：

​				

```xml
	<!--父级项目不需要打包所有packging的类型为pom-->
    	<packaging>pom</packaging>
<properties>
    <!--项目构建编码-->
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    <project.reporting.outputEncoding>UTF8</project.reporting.outputEncoding>
    <!--声明JDK版本-->
    <java.version>1.8</java.version>
    <!--spring cloud 版本.注意此版本是建立在boot2.2.2版本上的-->
    <mr.spring.cloud.version>Hoxton.SR1</mr.spring.cloud.version>
</properties>
<!--boot 版本-->
<parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-parent</artifactId>
    <version>2.3.1.RELEASE</version>
    <!--始终从仓库中获取，不从本地路径获取-->
    <relativePath />
</parent>
<dependencies>
    <!-- 集成commons工具类 -->
    <dependency>
        <groupId>org.apache.commons</groupId>
        <artifactId>commons-lang3</artifactId>
    </dependency>
    <!-- 集成lombok 框架 -->
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
    </dependency>
    <!--junit测试-->
    <dependency>
        <groupId>junit</groupId>
        <artifactId>junit</artifactId>
    </dependency>
    <!-- SpringBoot整合eureka客户端 -->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
    </dependency>
    <!--boot 测试模块-->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-test</artifactId>
        <scope>test</scope>
    </dependency>
</dependencies>
<!-- 项目依赖,子级模块可以继承依赖-->
<dependencyManagement>
    <dependencies>
        <!--cloud 依赖-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-dependencies</artifactId>
            <version>${mr.spring.cloud.version}</version>
            <type>pom</type>
            <!--解决maven单继承的问题-->
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>
<!-- 注意： 这里必须要添加， 否者各种依赖有问题 -->
<repositories>
    <repository>
        <id>spring-milestones</id>
        <name>Spring Milestones</name>
        <url>https://repo.spring.io/libs-milestone</url>
        <snapshots>
            <enabled>false</enabled>
        </snapshots>
    </repository>
</repositories>
```

#### lombok依赖: 

###### Lombok 是一种 Java™ 实用工具

可用来帮助开发人员消除 Java 的冗长

Lombok的主要作用是通过一些注解 例如@Data 作用就代替了get set 方法

要使用这个对象,必须还要写一些getter和setter方法,可能还要写一个构造器、equals方法、或者hash方法.这些方法很冗长而且没有技术含量,我们叫它样板式代码.

```java
@Data//lombok的注解
public class yangban{

	private Integer xxx;(样板式代码)
	
}
```

**lombok既是一个IDE插件,也是一个项目要依赖的jar包.**

#### **commons依赖：**

######  集成commons工具类 

| Commons-Lang3 | 封装了一些常用的工具类； 在研发阶段优先使用该包中提供的工具类； | AnnotationUtils ArchUtils ArrayUtils BitField BooleanUtils CharSequenceUtils CharSetUtils CharUtils ClassPathUtils ClassUtils EnumUtils LocaleUtils ObjectUtils RandomStringUtils RandomUtils SerializationUtils StringUtils SystemUtils ThreadUtils RegExUtils Validate | 提供对注解的一系列操作； 提供快速获取CPU基本信息的操作； 提供对数组的一系列操作； 提供对Bit的一系列操作； 提供对boolean或Boolean的一系列操作； 提供对一组字符串的一系列操作，会将String转成CharSequence； 提供对一组字符串的一系列操作，会将String专程CharSet； 提供对char或Char的一系列操作； 提供对ClassPath的一系列操作； 提供对Java类的一系列操作，没有使用反射实现； 提供对Enum的一系列操作； 提供对java.util.Locale的一系列操作； 提供对Object类的一系列操作； 提供一个生成随机字符串的类； 提供一个生成随机数的类； 提供一个序列号的类； 提供对String的一系列操作； 提供一个快速获取操作系统或JVM信息的类； 提供一个快速操作线程或线程组的类； 提供一个正则表达式的操作类； 提供一个简单的验证类，类似断言的用法； |
| ------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
|               |                                                              |                                                              |                                                              |

#### 单元测试依赖:

##### **顾名思义就是用来做单元测试的**（测试在公司实际中项目这个依赖可能没有）

<!--junit测试-->@AFTER @BEFORE @TEXT

#### 父级模块pom最后:

##### 避免一些jar冲突代码

```xml
<repositories>
    <repository>
        <id>spring-milestones</id>
        <name>Spring Milestones</name>
        <url>https://repo.spring.io/libs-milestone</url>
        <snapshots>
            <enabled>false</enabled>
        </snapshots>
    </repository>
</repositories>
```

### (basics)子级基础模块:

#### 		eureka服务模块

​		1.导入依赖eureka-server 

​			Eureka 是一个基于 REST 的服务，主要在 AWS 云中使用, 定位服务来进行中间层服务器的负载均衡和故障转移。

```xml
<dependencies>
    <!--eureka 服务依赖-->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
    </dependency>
</dependencies>
```

​		2.配置application.yml

```yml
server:
  port: 8761

spring:
  application:
    name: eureka-server

eureka:
  client:
    # eureka服务url,值为map集合默认key为defaultZone
    service-url:
      defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka
    # 当前服务是否同时注册
    register-with-eureka: false
    # 去注册中心获取其他服务的地址
    fetch-registry: false
  instance:
    hostname: localhost
    # 定义服务续约任务（心跳）的调用间隔，单位：秒 默认30
    lease-renewal-interval-in-seconds: 1
    # 定义服务失效的时间，单位：秒 默认90
    lease-expiration-duration-in-seconds: 2
  server:
    # 测试时关闭自我保护机制，保证不可用服务及时踢出
    enable-self-preservation: false
```

​		3.创建启动类

```java
//启动类注解
@SpringBootApplication
//声明当前是一个注册服务
@EnableEurekaServer
public class RunEurekaServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(RunEurekaServerApplication.class,args);
    }
}
```

#### 		zuul网关模块

​		1,导入依赖 netflix-zuul

​				zuul的主要功能是路由转发和过滤器。路由功能是微服务的一部分

```xml
<dependencies>
    <!-- zuul -->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-zuul</artifactId>
    </dependency>
</dependencies>
```

​		2,创建启动类

​		

```java
//启动类注解
@SpringBootApplication
//声明当前是一个zuul
@EnableZuulProxy
//注册到eureka服务中
@EnableEurekaClient
public class RunZuulServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(RunZuulServerApplication.class);
    }
}
```

​		3,创建application.yml

​		

```yml
server:
  port: 8088

spring:
  application:
    name: eureka-zuul

zuul:
  # 声明路由
  routes:
    # 路由名称
    api-xxx:
      # 声明将所有以/api-ribbon/的请求都转发到eureka-ribbon的服务中
      path: /api-xxx/**
      serviceId: xxx-server
  # 启用重试
  retryable: true
  #以下两个是默认规则,现在忽略,上传于下载时需要
  # 包含此路径的不进行路由
  ignored-patterns: /upload/**
  # 忽略上传服务
  ignored-services:
    -upload-server

#配置负载
ribbon:
  ConnectTimeout: 250 # 连接超时时间(ms)
  ReadTimeout: 2000 # 通信超时时间(ms)
  OkToRetryOnAllOperations: true # 是否对所有操作重试
  MaxAutoRetriesNextServer: 2 # 同一服务不同实例的重试次数
  MaxAutoRetries: 1 # 同一实例的重试次数
#配置熔断
hystrix:
  command:
    default:
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: 10000 # 熔断超时时长：6000ms
eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
```

​		4,解决跨域问题

​		

```java
@Configuration
public class GlobalCorsConfig {
    @Bean
    public CorsFilter corsFilter() {
        final UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        final CorsConfiguration config = new CorsConfiguration();
        config.setAllowCredentials(true); // 允许cookies跨域
        config.addAllowedOrigin("*");// 允许向该服务器提交请求的URI，*表示全部允许。这里尽量限制来源域，比如http://xxxx:8080 ,以降低安全风险。。
        config.addAllowedHeader("*");// 允许访问的头信息,*表示全部
        config.setMaxAge(18000L);// 预检请求的缓存时间（秒），即在这个时间段里，对于相同的跨域请求不会再预检了
        config.addAllowedMethod("*");// 允许提交请求的方法，*表示全部允许，也可以单独设置GET、PUT等
        config.addAllowedMethod("HEAD");
        config.addAllowedMethod("GET");// 允许Get的请求方法
        config.addAllowedMethod("PUT");
        config.addAllowedMethod("POST");
        config.addAllowedMethod("DELETE");
        config.addAllowedMethod("PATCH");
        source.registerCorsConfiguration("/**", config);
//3.返回新的CorsFilter.
        return new CorsFilter(source);
    }

}
```



#### 		upload下载服务

​		1,导入依赖

​		starter-web 依赖与 自定义的工具类

```xml
<dependencies>
    <!-- SpringBoot-整合Web组件 -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
	<!-- 导入自己的工具类 -->
    <dependency>
        <groupId>com.baidu</groupId>
        <artifactId>mingrui-shopcommon-core</artifactId>
        <version>1.0-SNAPSHOT</version>
    </dependency>

</dependencies>
```

​	2,创建启动类

```java
//启动类注解
@SpringBootApplication
//注册客户端
@EnableEurekaClient
public class RunUploadServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(RunUploadServerApplication.class);
    }
}
```

3,图片文件的上传

```java
@RestController
@RequestMapping(value = "upload")
public class UploadController extends BaseApiService{
    @Value(value = "${mingrui.upload.path.windows}")
    private String windowsPath;
    @Value(value = "${mingrui.upload.path.linux}")
    private String linuxPath;
    @Value(value = "${mingrui.upload.img.host}")
    private String imageHost;

    @PostMapping
    public Result<String> uploadImg(@RequestParam MultipartFile file) {

        if(file.isEmpty()) return this.setResultError("上传的文件为空");//判断上传的文件是否为空

        String filename = file.getOriginalFilename();//获取文件名

        //String path = "";
        String os = System.getProperty("os.name").toLowerCase();
        String path = os.indexOf("win") != -1 ? windowsPath : os.indexOf("lin") != -1 ? linuxPath : "";
//        if(os.indexOf("win") != -1){
//            path = windowsPath;
//        }else if(os.indexOf("lin") != -1){
//            path = linuxPath;
//        }

        //UUID.randomUUID() + 1.jpg UUID.randomUUID() + 1.jpg
        filename = UUID.randomUUID() + filename;//防止文件名重复

        //创建文件 路径+分隔符(linux和window的目录分隔符不一样)+文件名
        File dest = new File(path + File.separator + filename);

        //判断文件夹是否存在,不存在的话就创建
        if(!dest.getParentFile().exists()) dest.getParentFile().mkdirs();

        try {
            file.transferTo(dest);//上传
        } catch (IllegalStateException e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
        } catch (IOException e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
        }

        return this.setResult(HTTPStatus.OK,"upload success!!!",imageHost + "/" + filename);//将文件名返回页面用于页面回显
    }
```

​		4.解决跨域问题

```java
@Configuration
public class GlobalCorsConfig {
    @Bean
    public CorsFilter corsFilter() {
        final UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        final CorsConfiguration config = new CorsConfiguration();
        config.setAllowCredentials(true); // 允许cookies跨域
        config.addAllowedOrigin("*");// 允许向该服务器提交请求的URI，*表示全部允许。。这里尽量限制来源域，比如http://xxxx:8080 ,以降低安全风险。。
        config.addAllowedHeader("*");// 允许访问的头信息,*表示全部
        config.setMaxAge(18000L);// 预检请求的缓存时间（秒），即在这个时间段里，对于相同的跨域请求不会再预检了
        config.addAllowedMethod("*");// 允许提交请求的方法，*表示全部允许，也可以单独设置GET、PUT等
        config.addAllowedMethod("HEAD");
        config.addAllowedMethod("GET");// 允许Get的请求方法
        config.addAllowedMethod("PUT");
        config.addAllowedMethod("POST");
        config.addAllowedMethod("DELETE");
        config.addAllowedMethod("PATCH");
        source.registerCorsConfiguration("/**", config);
        //3.返回新的CorsFilter.
        return new CorsFilter(source);
    }
}
```

### (commoms)子级工具类模块

###### 		作用:提供各种各样的封装工具类

​		该模块下有好多封装成的工具类

```xml
<dependencies>

    <!--帮助开发人员快速生成API文档-->
    <dependency>
        <groupId>io.springfox</groupId>
        <artifactId>springfox-swagger2</artifactId>
        <version>2.9.2</version>
    </dependency>

    <!-- SpringBoot-整合Web组件 -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>


    <!--处理json与各种数据类型或文档类型的转换-->
    <dependency>
        <groupId>com.google.code.gson</groupId>
        <artifactId>gson</artifactId>
        <version>2.8.5</version>
    </dependency>
    <!--json对象序列化和反序列化的支持-->
    <dependency>
        <groupId>org.codehaus.jackson</groupId>
        <artifactId>jackson-core-lgpl</artifactId>
        <version>1.9.13</version>
    </dependency>
    <dependency>
        <groupId>org.codehaus.jackson</groupId>

        <artifactId>jackson-mapper-lgpl</artifactId>
        <version>1.9.13</version>
    </dependency>
    <!--java对象和json对象之间的转换-->
    <dependency>
        <groupId>org.codehaus.jackson</groupId>
        <artifactId>jackson-core-asl</artifactId>
        <version>1.9.13</version>
    </dependency>
    <dependency>
        <groupId>org.codehaus.jackson</groupId>
        <artifactId>jackson-mapper-asl</artifactId>
        <version>1.9.13</version>
    </dependency>
    <!--alibaba的json处理工具-->
    <dependency>
        <groupId>com.alibaba</groupId>
        <artifactId>fastjson</artifactId>
        <version>1.2.62</version>
    </dependency>
    <dependency>
        <groupId>com.fasterxml.jackson.core</groupId>
        <artifactId>jackson-databind</artifactId>
        <version>2.11.2</version>
    </dependency>

    <dependency>
        <groupId>com.belerweb</groupId>
        <artifactId>pinyin4j</artifactId>
        <version>2.5.1</version>
    </dependency>

</dependencies>
```

封装工具类里面需要的依赖 

### (service)子级服务系统模块实现

###### 该模块存放接口实现类

```xml
<dependencies>

    <!-- SpringBoot-整合Web组件 -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>

    <!-- springcloud feign组件 -->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-openfeign</artifactId>
    </dependency>

    <!--mysql数据库连接-->
    <dependency>
        <groupId>mysql</groupId>
        <artifactId>mysql-connector-java</artifactId>
        <scope>runtime</scope><!--项目运行阶段使用-->
        <version>5.1.37</version>
    </dependency>

    <!--通用mapper-->
    <dependency>
        <groupId>tk.mybatis</groupId>
        <artifactId>mapper-spring-boot-starter</artifactId>
        <version>2.1.5</version>
    </dependency>

    <!--分页工具-->
    <dependency>
        <groupId>com.github.pagehelper</groupId>
        <artifactId>pagehelper-spring-boot-starter</artifactId>
        <version>1.2.10</version>
    </dependency>

    <dependency>
        <groupId>com.baidu</groupId>
        <artifactId>mingrui-shopservice-api-xxx</artifactId>
        <version>1.0-SNAPSHOT</version>
    </dependency>

</dependencies>
```

SpringBoot-整合Web组件的依赖:

主要作用是提供Web开发场景所需的底层所有依赖

​	1.@RestController() 包含了@Controller和@ResponseBody两个注解。@Controller将当前类标记为一个控制器类			@ResponseBody将java对象转为json格式的数据。

​	 2.@RequestMapping 映射请求。用户在发送请求时，对url会进行映射，找到对应的方法执行。等。。。。。。

springcloud feign组件依赖：

​		用于做负载均衡，熔断等操作

通用mapper (tkMapper):

​	    通用mapper 可以极大的方便开发人员进行ORM，提供极其方便的单表增删改查。
 	  什么是通用mapper，一句话简单说，它就是个辅助mybatis极简单表开发的组件。它不是为了替代mybatis，而是让		mybatis的开发更方便。

​		可以按照自己的需要选择通用方法，还能很方便的开发自己的通用方法

分页工具依赖（pagehelper-spring-boot-starter）:

```java
//分页
PageHelper.startPage(brandDTO.getPage(),brandDTO.getRows());
```

​		用于分页，如上所示

### (service-api)子级服务	核心模块

###### 该模块里存放接口

```xml
<dependencies>
    <!-- SpringBoot-整合Web组件 -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>

    <!--Entity 中的@Table 和@Id需要次注解-->
    <dependency>
        <groupId>javax.persistence</groupId>
        <artifactId>persistence-api</artifactId>
        <version>1.0.2</version>
    </dependency>
    <!--2.3版本之后web删除了验证插件-->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-validation</artifactId>
    </dependency>
    <!--引入common工程代码-->
    <dependency>
        <groupId>com.baidu</groupId>
        <artifactId>mingrui-shopcommon-core</artifactId>
        <version>1.0-SNAPSHOT</version>
    </dependency>

    <!--分页工具-->
    <dependency>
        <groupId>com.github.pagehelper</groupId>
        <artifactId>pagehelper-spring-boot-starter</artifactId>
        <version>1.2.10</version>
    </dependency>

</dependencies>
```

## 二、总结

以上所述是框架的基本结构

#### 框架所带来的优点：分工明确，将微服务概念展现到了极致！！！让(模块)服务复用

# 商品分类模块

## 一、使用域名访问本地项目

#### 统一环境

​		1.修改本地的 host实现域名的关系映射

​		2.启动vue项目测试
​		

​		页面(Invalid Host header)

​		3.输入域名 + 9001端口号出现上述错误 打开build文件夹下webpack.dev.conf.js文件在devServer下加入 						                               	disableHostCheck: true

​		4.再次编译项目

​		5.域名解析成功

#### nginx解决端口问题

我们希望的是直接域名访问： http://manage.mrshop.com 。这种情况下端口默认是80，如何才能把 请求转移到9001端口呢？ 这里就要用到反向代理工具：Nginx

什么是Nginx?

Nginx是一款自由的、开源的、高性能的HTTP服务器和反向代理服务器；同时也是一个IMAP、POP3、SMTP代理服务器；Nginx可以作为一个HTTP服务器进行网站的发布处理，另外Nginx可以作为反向代理进行负载均衡的实现。

Nginx正向代理反向代理:https://www.cnblogs.com/wcwnina/p/8728391.html

#####  安装和使用

解压nginx-1.16.1.zip

nginx可以通过命令行来启动，操作命令： 启动： start nginx.exe 停止： nginx.exe -s stop 重新加载： nginx.exe -s reload

反向代理配置

修改nginx/conf/nginx.conf文件



```
worker_processes  1;
events {
    worker_connections  1024;
}
http {
    include       mime.types;
    default_type  application/octet-stream;
	
	
    sendfile        on;
	keepalive_timeout 65;

    server {
        listen       80;
        server_name manage.mrshop.com;
		
		
		proxy_set_header X-Forwarded-Host $host;
		proxy_set_header X-Forwarded-Server $host;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		
		
        location / {
			proxy_pass http://127.0.0.1:9001;
			proxy_connect_timeout 600;
			proxy_read_timeout 600;
        }
		
    }
	
	server {
		listen 80;
		server_name api.mrshop.com;
		
		proxy_set_header X-Forwarded-Host $host;
		proxy_set_header X-Forwarded-Server $host;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		
		
		location / {
			proxy_pass http://127.0.0.1:8088;
			proxy_connect_timeout 600;
			proxy_read_timeout 600;
		}
		
		# 上传路径的映射
		# 只要包含/api-xxx/upload 都会把请求映射到8200服务
		# rewrite "^/api-xxx/(.*)$" /$1 break;
		# 将/api-xxx 替换成/
		location /api-xxx/upload {
		proxy_pass http://127.0.0.1:8200;
		proxy_connect_timeout 600;
		proxy_read_timeout 600;
		rewrite "^/api-xxx/(.*)$" /$1 break;
		}
		
	}
	
	server {
		listen 80;
		server_name image.mrshop.com;
		
		proxy_set_header X-Forwarded-Host $host;
		proxy_set_header X-Forwarded-Server $host;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		
		location ~ .*\.(gif|jpg|pdf|jpeg|png)$
		{
			#root D:/nginx-1.15.5/temp/images/;
			#指定图片存放路径(可以放在nginx文件夹路径里也可以放其他p盘)
			root E:\images;
		}
		
		location / {
			root html;
			index index.html index.htm;
		}
	}

}

```

 最终测试

## 二、商品分类管理

#### 搭建

##### 	mingrui-shop-common-core工程

 在mingrui-shop--commons项目下新建mingrui-shopcommon-core项目

​		pom

```xml
<dependencies>

    <!--帮助开发人员快速生成API文档-->
    <dependency>
        <groupId>io.springfox</groupId>
        <artifactId>springfox-swagger2</artifactId>
        <version>2.9.2</version>
    </dependency>

    <!-- SpringBoot-整合Web组件 -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>


    <!--处理json与各种数据类型或文档类型的转换-->
    <dependency>
        <groupId>com.google.code.gson</groupId>
        <artifactId>gson</artifactId>
        <version>2.8.5</version>
    </dependency>
    <!--json对象序列化和反序列化的支持-->
    <dependency>
        <groupId>org.codehaus.jackson</groupId>
        <artifactId>jackson-core-lgpl</artifactId>
        <version>1.9.13</version>
    </dependency>
    <dependency>
        <groupId>org.codehaus.jackson</groupId>

        <artifactId>jackson-mapper-lgpl</artifactId>
        <version>1.9.13</version>
    </dependency>
    <!--java对象和json对象之间的转换-->
    <dependency>
        <groupId>org.codehaus.jackson</groupId>
        <artifactId>jackson-core-asl</artifactId>
        <version>1.9.13</version>
    </dependency>
    <dependency>
        <groupId>org.codehaus.jackson</groupId>
        <artifactId>jackson-mapper-asl</artifactId>
        <version>1.9.13</version>
    </dependency>
    <!--alibaba的json处理工具-->
    <dependency>
        <groupId>com.alibaba</groupId>
        <artifactId>fastjson</artifactId>
        <version>1.2.62</version>
    </dependency>
    <dependency>
        <groupId>com.fasterxml.jackson.core</groupId>
        <artifactId>jackson-databind</artifactId>
        <version>2.11.2</version>
    </dependency>

    <dependency>
        <groupId>com.belerweb</groupId>
        <artifactId>pinyin4j</artifactId>
        <version>2.5.1</version>
    </dependency>

</dependencies>
```

新建包com.baidu.shop.utils

JSONUtil

```java
package com.baidu.shop.utils;

import com.alibaba.fastjson.JSONObject;
import org.codehaus.jackson.JsonParseException;
import org.codehaus.jackson.map.JsonMappingException;
import org.codehaus.jackson.map.ObjectMapper;
import org.codehaus.jackson.type.TypeReference;
import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import com.google.gson.JsonArray;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import com.google.gson.reflect.TypeToken;
import java.io.FileOutputStream;
import java.io.IOException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
;

/**
 * @ClassName JSONUtil
 * @Description: TODO
 * @Author wanglonglong
 * @Date 2020/12/22
 * @Version V1.0
 **/
public class JSONUtil {
    private static Gson gson = null;
    static {
        gson = new GsonBuilder().setDateFormat("yyyy-MM-dd HH:mm:ss").create();// todo yyyy-MM-dd HH:mm:ss
    }
    public static synchronized Gson newInstance() {
        if (gson == null) {
            gson = new GsonBuilder().setDateFormat("yyyy-MM-dd HH:mm:ss").create();
        }
        return gson;
    }
    public static String toJsonString(Object obj) {
        return gson.toJson(obj);
    }
    public static <T> T toBean(String json, Class<T> clz) {
        return gson.fromJson(json, clz);
    }
    public static <T> Map<String, T> toMap(String json, Class<T> clz) {
        Map<String, JsonObject> map = gson.fromJson(json, new
                TypeToken<Map<String, JsonObject>>() {
                }.getType());
        Map<String, T> result = new HashMap<String, T>();
        for (String key : map.keySet()) {
            result.put(key, gson.fromJson(map.get(key), clz));
        }
        return result;
    }
    public static Map<String, Object> toMap(String json) {
        Map<String, Object> map = gson.fromJson(json, new TypeToken<Map<String,
                Object>>() {
        }.getType());
        return map;
    }
    public static <T> List<T> toList(String json, Class<T> clz) {
        JsonArray array = new JsonParser().parse(json).getAsJsonArray();
        List<T> list = new ArrayList<T>();
        for (final JsonElement elem : array) {
            list.add(gson.fromJson(elem, clz));
        }
        return list;
    }
    /**
     * 从json字符串中获取需要的值
     *
     * @param json
     * @param clazz 要转换的类型
     * @return
     */
    public static <T> Object getObjectByKey(String json, Class<T> clazz) {
        if (json != null && !"".equals(json)) {
            return JSONObject.parseObject(json, clazz);
        }
        return null;
    }
    /**
     * 从json字符串中获取需要的值
     *
     * @param json
     * @param clazz 要转换的类型
     * @return
     */
    public static <T> List<T> getListByKey(String json, Class<T> clazz) {
        if (json != null && !"".equals(json)) {
            return JSONObject.parseArray(json, clazz);
        }
        return null;
    }
    /**
     * 从json字符串中获取需要的值
     *
     * @param json
     * @param key
     * 键
     * @return
     */
    public static String getStrByKey(String json, String key) {
        String str = "";
        if (json != null && !"".equals(json)) {
            JSONObject j = JSONObject.parseObject(json);
            if (j.get(key) != null) {
                str = j.get(key).toString();
            }
        }
        return str;
    }
    /**
     * 向文件中写数据
     *
     * @param _sDestFile
     * @param _sContent
     * @throws IOException
     */
    public static void writeByFileOutputStream(String _sDestFile, String
            _sContent) throws IOException {
        FileOutputStream fos = null;
        try {
            fos = new FileOutputStream(_sDestFile);
            fos.write(_sContent.getBytes());
        } catch (Exception ex) {
            ex.printStackTrace();
        } finally {
            if (fos != null) {
                fos.close();
                fos = null;
            }
        }
    }
    /**
     * 非空
     *
     * @param str
     * @return true:不为空 false：空
     */
    public static boolean noEmpty(String str) {
        boolean flag = true;
        if ("".equals(str)) {
            flag = false;
        }
        return flag;
    }
    /**
     * 将"%"去掉
     *
     * @param str
     * @return
     */
    public static double getDecimalByPercentage(String str) {
        double fuse = 0.0;
        if (!"".equals(str) && str != null) {
            if (str.split("%").length > 0) {
                fuse = Double.parseDouble(str.split("%")[0]);
                return fuse;
            }
        }
        return 0.0;
    }
    /**
     * 保留2位小数
     *
     * @param number
     * @return
     */
    public static double ConversionFraction(double number) {
        return Math.floor(number * 100 + 0.5) / 100;
    }
    public static float ConversionM(double number) {
        return (float) JSONUtil.ConversionFraction(number / 1024 / 1024);
    }
    public static String getErrorText(String s) {
        JSONObject j = JSONObject.parseObject(s);
        return
                j.getJSONObject(j.keySet().iterator().next()).get("errortext").toString();
    }

    public static String getSingleJobId(String s) throws Exception {
        JSONObject j = JSONObject.parseObject(s);
        try {
            return
                    j.getJSONObject(j.keySet().iterator().next()).get("jobid").toString();
        } catch (Exception e) {
            try {
                return
                        j.getJSONObject(j.keySet().iterator().next()).get("errortext").toString();
            } catch (Exception e1) {
                throw new Exception(e1.getMessage());
            }
        }
    }
    public static <T> T readValue(String jsonStr, TypeReference type)
            throws JsonParseException, JsonMappingException, IOException {
        ObjectMapper mapper = new ObjectMapper();
        return mapper.readValue(jsonStr, type);
    }
    public static JSON_TYPE getJSONType(String str) {
        if (null == str || "".equals(str)) {
            return JSON_TYPE.JSON_TYPE_ERROR;
        }
        final char[] strChar = str.substring(0, 1).toCharArray();
        final char firstChar = strChar[0];
        if (firstChar == '{') {
            return JSON_TYPE.JSON_TYPE_OBJECT;
        } else if (firstChar == '[') {
            return JSON_TYPE.JSON_TYPE_ARRAY;
        } else {
            return JSON_TYPE.JSON_TYPE_ERROR;
        }
    }
    public enum JSON_TYPE {
        /** JSONObject */
        JSON_TYPE_OBJECT,
        /** JSONArray */
        JSON_TYPE_ARRAY,
        /** 不是JSON格式的字符串 */
        JSON_TYPE_ERROR
    }

}

```

 新建包com.baidu.shop.status

HTTPStatus

```java
package com.baidu.shop.status;

/**
 * @ClassName HTTPStatus
 * @Description: TODO
 * @Author wanglonglong
 * @Date 2020/12/22
 * @Version V1.0
 **/
public class HTTPStatus {
    public static final int OK = 200;//成功

    public static final int ERROR = 500;//失败

    public static final int PARAMS_VALIDATE_ERROR = 5002;//参数校验失败

}

```

新建包com.baidu.shop.base

Result

```java
package com.baidu.shop.base;

import lombok.Data;
import lombok.NoArgsConstructor;

/**
 * @ClassName Result
 * @Description: TODO
 * @Author wanglonglong
 * @Date 2020/12/22
 * @Version V1.0
 **/
@Data
@NoArgsConstructor
public class Result<T> {

    private Integer code;//返回码

    private String message;//返回信息

    private T data;//返回的数据

    public Result(Integer code,String message,Object data){
        this.code = code;
        this.message = message;
        this.data = (T) data;
    }

}

```

BaseApiService

```java
package com.baidu.shop.base;

import com.baidu.shop.status.HTTPStatus;
import com.baidu.shop.utils.JSONUtil;
import lombok.Data;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

/**
 * @ClassName BaseApiService
 * @Description: TODO
 * @Author wanglonglong
 * @Date 2020/12/22
 * @Version V1.0
 **/
@Data
@Component
@Slf4j
public class BaseApiService<T> {
    public Result<T> setResultError(Integer code, String msg) {
        return setResult(code, msg, null);
    }
    // 返回错误，可以传msg
    public Result<T> setResultError(String msg) {
        return setResult(HTTPStatus.ERROR, msg, null);
    }
    // 返回成功，可以传data值
    public Result<T> setResultSuccess(T data) {
        return setResult(HTTPStatus.OK, HTTPStatus.OK + "", data);
    }
    // 返回成功，沒有data值
    public Result<T> setResultSuccess() {
        return setResult(HTTPStatus.OK, HTTPStatus.OK + "", null);
    }
    // 返回成功，沒有data值
    public Result<T> setResultSuccess(String msg) {
        return setResult(HTTPStatus.OK, msg, null);
    }
    // 通用封装
    public Result<T> setResult(Integer code, String msg, T data) {
        log.info(String.format("{code : %s , msg : %s , data : %s}",code,msg,
                JSONUtil.toJsonString(data)));
        return new Result<T>(code, msg, data);
    }

}

```

##### service-api工程

在mingrui-shop-service-api项目下新建mingrui-shopservice-api-xxx项目

 pom.xml	

```xml
<dependencies>

    <!--帮助开发人员快速生成API文档-->
    <dependency>
        <groupId>io.springfox</groupId>
        <artifactId>springfox-swagger2</artifactId>
        <version>2.9.2</version>
    </dependency>
    <!--提供可视化的API文档-->
    <dependency>
        <groupId>io.springfox</groupId>
        <artifactId>springfox-swagger-ui</artifactId>
        <version>2.9.2</version>
    </dependency>
    <dependency>
        <groupId>com.github.pagehelper</groupId>
        <artifactId>pagehelper</artifactId>
        <version>5.1.8</version>
        <scope>compile</scope>
    </dependency>

</dependencies>
```

新建包com.baidu.shop.entity

CategoryEntity

```java
package com.baidu.shop.entity;

import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;
import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;

/**
 * @ClassName CategoryEntity
 * @Description: TODO
 * @Author wanglonglong
 * @Date 2020/12/22
 * @Version V1.0
 **/
@ApiModel(value = "分类实体类")
@Data
@Table(name = "tb_category")
public class CategoryEntity {
    @Id
    @ApiModelProperty(value = "类目id",example = "1")
    @NotNull(message = "Id不能空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "类目名称")
    @NotEmpty(message = "name不能空",groups = {MingruiOperation.Update.class,MingruiOperation.Add.class})
    private String name;
    @ApiModelProperty(value = "父类目id,顶级类目填0",example = "1")
    @NotNull(message = "父Id不能空",groups = {MingruiOperation.Add.class})
    private Integer parentId;
    @ApiModelProperty(value = "是否为父节点，0为否，1为是",example = "1")
    @NotNull(message = "是否为父节点不能为Null",groups = {MingruiOperation.Add.class})
    private Integer isParent;
    @ApiModelProperty(value = "排序指数，越小越靠前",example = "1")
    @NotNull(message = "排序字段不能为空",groups = {MingruiOperation.Add.class})
    private Integer sort;
}

```

swagger2的配置

com.baidu.shop.config.MrSwagger2Config

```java
package com.baidu.shop.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import springfox.documentation.builders.ApiInfoBuilder;
import springfox.documentation.builders.PathSelectors;
import springfox.documentation.builders.RequestHandlerSelectors;
import springfox.documentation.service.ApiInfo;
import springfox.documentation.service.Contact;
import springfox.documentation.spi.DocumentationType;
import springfox.documentation.spring.web.plugins.Docket;
import springfox.documentation.swagger2.annotations.EnableSwagger2;


/**
 * @ClassName MrSwagger2Config
 * @Description: TODO
 * @Author wanglonglong
 * @Date 2020/12/22
 * @Version V1.0
 **/
@Configuration
@EnableSwagger2
public class MrSwagger2Config {
    @Bean
    public Docket createRestApi(){
        return new Docket(DocumentationType.SWAGGER_2)
                .apiInfo(this.apiInfo())
                .select()
                .apis(RequestHandlerSelectors.basePackage("com.baidu"))
                .paths(PathSelectors.any())
                .build();
    }
    private ApiInfo apiInfo(){
        return new ApiInfoBuilder()
//标题
                .title("明瑞SWAGGER2标题")
//条款地址
                .termsOfServiceUrl("http://www.baidu.com")
//联系方式-->有String参数的方法但是已经过时，所以不推荐使用
                .contact(new Contact("wanglonglong","baidu.com","wanglonglongiii@163.com"))
//版本
                .version("v1.0")
//项目描述
                .description("描述")
//创建API基本信息
                .build();
    }

}
```

定义分类接口

```java
@Api(tags = "商品分类接口")
public interface CategoryService {
@ApiOperation(value = "通过查询商品分类")
@GetMapping(value = "category/list")
Result<List<CategoryEntity>> getCategoryByPid(Integer pid);
}
```

service工程

mingrui-shop-service/pom.xml

```xml
<dependencies>
    <!-- SpringBoot-整合Web组件 -->
    <dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <!-- springcloud feign组件 -->
    <dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
    </dependency>
    <!--mysql数据库连接-->
    <dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
    <scope>runtime</scope><!--项目运行阶段使用-->
    </dependency>
    <!--通用mapper-->
    <dependency>
    <groupId>tk.mybatis</groupId>
    <artifactId>mapper-spring-boot-starter</artifactId>
    <version>2.1.5</version>
    </dependency>
    <!--分页工具-->
    <dependency>
    <groupId>com.github.pagehelper</groupId>
    <artifactId>pagehelper-spring-boot-starter</artifactId>
    <version>1.2.10</version>
    </dependency>
    <dependency>
    <groupId>com.baidu</groupId>
    <artifactId>mingrui-shop-service-api-xxx</artifactId>
    <version>1.0-SNAPSHOT</version>
    </dependency>
</dependencies>
```

在mingrui-shop-service工程下新建mingrui-shop-servicexxx工程

application.yml

```yml
server:
  port: 8100


spring:
  application:
    name: xxx-server
  # 配置数据源
  datasource:
    # 数据源名称，任意
    name: mysql
    url: jdbc:mysql://localhost:3306/2005?useUnicode=true&characterEncoding=utf8
    # 数据库连接用户
    username: root
    # 数据库连接密码
    password: root
    # 驱动名称
    driver-class-name: com.mysql.jdbc.Driver
    # boot2.0+使用hikari作为默认数据库连接池
    type: com.zaxxer.hikari.HikariDataSource
    hikari:
      # 是否自动提交事务 默认
      auto-commit: true
      # 允许的最小连接数
      minimum-idle: 5
      # 连接池内最大连接数
      maximum-pool-size: 10
      # 验证连接的sql语句
      connection-test-query: SELECT 1 FROM DUAL
      # 连接超时时间 默认30000 毫秒 如果小于250毫秒，则被重置回30秒
      connection-timeout: 30000
      # 验证超时时间默认5000毫秒 如果小于250毫秒，则会被重置回5秒
      validation-timeout: 5000
      # 设置连接在连接池中的存货时间 如果不等于0且小于30秒则会被重置回30分钟
      max-lifetime: 1800000

# 通用mapper
mapper:
  mappers: tk.mybatis.mapper.common.Mapper
  identity: MYSQL
#日志设置
logging:
  level:
  # 打印与我们程序相关的日志信息
    com.baidu.shop: debug
# eureka配置
eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
```

新建包com.baidu

 	新建启动类

```java
@SpringBootApplication
@EnableEurekaClient
@MapperScan("com.baidu.shop.mapper")
public class RunXXXApplication {
    public static void main(String[] args) {
    	SpringApplication.run(RunXXXApplication.class);
    }
}

```

 在com.baidu下新建包shop.mapper

 创建mapper

```java
public interface CategoryMapper extends Mapper<CategoryEntity> {
}
```

在com.baidu下新建包shop.service.impl\

新建实现类

```java
@RestController
public class CategoryServiceImpl extends BaseApiService implements CategoryService {
@Autowired
private CategoryMapper categoryMapper;
    @Override
    public Result<List<CategoryEntity>> getCategoryByPid(Integer pid) {
        CategoryEntity categoryEntity = new CategoryEntity();
        categoryEntity.setParentId(pid);
        List<CategoryEntity> list = categoryMapper.select(categoryEntity);
        return this.setResultSuccess(list);
    }
}

```

即可查询

后续启用网关服务前台修改,

以下是解决跨域问题

```java
package com.baidu.global;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
import org.springframework.web.filter.CorsFilter;


/**
 * @ClassName GlobalCorsConfig
 * @Description: TODO
 * @Author wanglonglong
 * @Date 2020/12/23
 * @Version V1.0
 **/
@Configuration
public class GlobalCorsConfig {
    @Bean
    public CorsFilter corsFilter() {
        final UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        final CorsConfiguration config = new CorsConfiguration();
        config.setAllowCredentials(true); // 允许cookies跨域
        config.addAllowedOrigin("*");// 允许向该服务器提交请求的URI，*表示全部允许。这里尽量限制来源域，比如http://xxxx:8080 ,以降低安全风险。。
        config.addAllowedHeader("*");// 允许访问的头信息,*表示全部
        config.setMaxAge(18000L);// 预检请求的缓存时间（秒），即在这个时间段里，对于相同的跨域请求不会再预检了
        config.addAllowedMethod("*");// 允许提交请求的方法，*表示全部允许，也可以单独设置GET、PUT等
        config.addAllowedMethod("HEAD");
        config.addAllowedMethod("GET");// 允许Get的请求方法
        config.addAllowedMethod("PUT");
        config.addAllowedMethod("POST");
        config.addAllowedMethod("DELETE");
        config.addAllowedMethod("PATCH");
        source.registerCorsConfiguration("/**", config);
//3.返回新的CorsFilter.
        return new CorsFilter(source);
    }

}
```



​		增删改查

​		api-server 下新建接口

```java
@Api(tags = "商品分类接口")
public interface CategoryService {

    @ApiOperation(value = "通过品牌id查询商品分类")
    @GetMapping(value = "category/getByBrand")
    Result<List<CategoryEntity>> getByBrand(Integer brandId);

    @ApiOperation(value = "通过查询商品分类")
    @GetMapping(value = "category/list")

    Result<List<CategoryEntity>> getCategoryByPid(Integer pid);

    @ApiOperation(value = "通过查询Id删除分类")
    @DeleteMapping(value = "category/list")
    Result<JsonObject> deleteCategoryById(Integer id);

    @ApiOperation(value = "改变")
    @PutMapping(value = "category/update")
        //声明哪个组下面的参数参加校验-->当前是校验改变
    Result<JsonObject> updateCategory(@Validated({MingruiOperation.Update.class}) @RequestBody CategoryEntity entity);

    @ApiOperation(value = "新增")
    @PostMapping(value = "category/save")
        //声明哪个组下面的参数参加校验-->当前是校验新增组
    Result<JsonObject> saveCategory(@Validated({MingruiOperation.Add.class})@RequestBody CategoryEntity entity);
}
```

```java
新建 mapper

package com.baidu.shop.mapper;

import com.baidu.shop.entity.CategoryEntity;
import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.common.Mapper;

import java.util.List;

/**
 * @ClassName CategoryMapper
 * @Description: TODO
 * @Author wanglonglong
 * @Date 2020/12/22
 * @Version V1.0
 **/
public interface CategoryMapper extends Mapper<CategoryEntity> {
    @Select(value = "select id,name from tb_category where id in (select category_id from tb_category_brand where brand_id=#{brandId})")
    List<CategoryEntity> getByBrandId(Integer brandId);
}
```



server-xxx下新建接口	

```java
package com.baidu.shop.service.impl;

import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.entity.CategoryBrandEntity;
import com.baidu.shop.entity.CategoryEntity;
import com.baidu.shop.mapper.CategoryBrandMapper;
import com.baidu.shop.mapper.CategoryMapper;
import com.baidu.shop.service.CategoryService;
import com.baidu.shop.utils.ObjectUtil;
import com.google.gson.JsonObject;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.bind.annotation.RestController;
import tk.mybatis.mapper.entity.Example;

import java.util.List;

/**
 * @ClassName CategoryServiceImpl
 * @Description: TODO
 * @Author wanglonglong
 * @Date 2020/12/22
 * @Version V1.0
 **/
@RestController
public class CategoryServiceImpl extends BaseApiService implements CategoryService {
    @Autowired
    private CategoryMapper categoryMapper;

    @Autowired
    private CategoryBrandMapper categoryBrandMapper;

    @Override
    public Result<List<CategoryEntity>> getByBrand(Integer brandId) {
        List<CategoryEntity> list = categoryMapper.getByBrandId(brandId);
        return this.setResultSuccess(list);
    }

    @Override
    @Transactional
    public Result<JsonObject> saveCategory(CategoryEntity entity) {
        CategoryEntity saveCategoryEntity = new CategoryEntity();
        saveCategoryEntity.setIsParent(1);
        saveCategoryEntity.setId(entity.getParentId());
        categoryMapper.updateByPrimaryKeySelective(saveCategoryEntity);


        categoryMapper.insertSelective(entity);

        return this.setResultSuccess();
    }

    @Override
    @Transactional
    public Result<JsonObject> updateCategory(CategoryEntity entity) {
        categoryMapper.updateByPrimaryKeySelective(entity);
        return this.setResultSuccess();
    }

    @Override
    public Result<List<CategoryEntity>> getCategoryByPid(Integer pid) {
        CategoryEntity categoryEntity = new CategoryEntity();
        categoryEntity.setParentId(pid);
        List<CategoryEntity> list = categoryMapper.select(categoryEntity);

        return this.setResultSuccess(list);
    }

    @Override
    //事务的特性
    @Transactional
    public Result<JsonObject> deleteCategoryById(Integer id) {

        //先判断Id是否合法,合法执行下面代码不合法直接return；
        if(ObjectUtil.isNull(id) || id < 0) return this.setResultError("id不合法");

        //通过id查询出当前节点的状态
        CategoryEntity categoryEntity = categoryMapper.selectByPrimaryKey(id);

        //查看当前节点是否有绑定分类信息 如果有则不能删除
        Example example1 = new Example(CategoryBrandEntity.class);
        example1.createCriteria().andEqualTo("categoryId",id);
        List<CategoryBrandEntity> categoryBrandEntities = categoryBrandMapper.selectByExample(example1);
        if (categoryBrandEntities.size() >= 1) return this.setResultError("有绑定信息不能删除");


        //如果查询不到数据也会执行null 例如传一个大于数据库里数据的Id 这时候就有次问题了
        if (ObjectUtil.isNull(categoryEntity)) return this.setResultError("没有这条数据");

        //查看当前节点是否为父级节点，如果是父级节点则不能删除
        if(categoryEntity.getParentId() == 1)return this.setResultError("当前为父级Id不能删除");

        //查看当前节点的父Id下是否有其他子节点
        Example example = new Example(CategoryEntity.class);
        Example.Criteria criteria = example.createCriteria();
        criteria.andEqualTo("parentId",categoryEntity.getParentId());
        List<CategoryEntity> categoryEntitiesList = categoryMapper.selectByExample(example);

        //如果当前节点的父Id下有其他子节点的个数小于或等于1个的时候执行 大于一个节点这不执行
        if(categoryEntitiesList.size() <= 1){
            //当前节点删除后，父节点parentId 变成字节点（即叶子节点）//原因！！因为变成叶子节点后才可以被删除点
            CategoryEntity updateCategoryEntity = new CategoryEntity();
            //isParentId为零则就不是父节点了
            updateCategoryEntity.setIsParent(0);
            //再把已经修改为0的节点赋值到setId
            updateCategoryEntity.setId(categoryEntity.getParentId());
            //update
            categoryMapper.updateByPrimaryKeySelective(updateCategoryEntity);
        }

        //执行删除操作
        categoryMapper.deleteByPrimaryKey(id);
        return this.setResultSuccess();
    }
}
```

# 商品分类模块-流程

## 品牌分类(CRUD)

#### 查询-

​	前台

​	首先把前台自带的分页取消掉

​	并且在前台找到 传入参数的地址,使用axios get到后台

​	后台

​		在api-server下创建品牌管理的实体类,并且创建DTO(传输对象),并且创建接口接收前台传递的参数

​			在mingrui-shop-server-xxx下新建Mapper , (通用Mapper) 以上文档有关于通用Mapper介绍

​			并且新建接口的实现类

​				根据pid查询数据

#### 删除-

前台传来Id 后台接收

判断Id是否合法

通过id查询出来当前节点的状态

查看当前节点是否有绑定分类信息,如果有则不能删除

查看当前节点的父Id下是否有其他子节点

如果当前节点的父Id下有其他子节点的个数小于或等于1个的时候执行 大于一个节点这不执行

当前节点删除后，父节点parentId 变成字节点（即叶子节点）//原因！！因为变成叶子节点后才可以被删除点

执行删除操作

#### 新增-

新增完毕后,如果新增的是一个父节点需要后台修改IsParent为1

#### 修改-

前台回显

后台直接写Updade方法

# 品牌管理模块-流程

## 品牌管理(CRUD)

#### 查询-

```
    //分页
        PageHelper.startPage(brandDTO.getPage(),brandDTO.getRows());

        BrandEntity brandEntity = BeanCopy.copyProperties(brandDTO, BrandEntity.class);
        Example example = new Example(BrandEntity.class);
        Example.Criteria criteria = example.createCriteria();
        if(!StringUtils.isEmpty(brandDTO.getSort()))
            // BrandEntity brandEntity = new BrandEntity();
//        brandDTO.setId(brandEntity.getId());
//        brandDTO.setName(brandEntity.getName());
            //排序
//        if (!StringUtil.isEmpty(brandDTO.getSort())){
//            String order = "asc";
//            if (Boolean.valueOf(brandDTO.getOrder())){
//                order = "desc";
//            }else{
//                order = "asc";
//            }
//        }
            PageHelper.orderBy(brandDTO.getSort() + " " + (Boolean.valueOf(brandDTO.getOrder()) ? "desc" : "asc"));

        criteria.andLike("name","%"+brandDTO.getName()+"%");

        List<BrandEntity> list = brandMapper.selectByExample(example);

        PageInfo<BrandEntity> pageInfo = new PageInfo<>(list);

        return this.setResultSuccess(pageInfo);
```

#### 新增-

```java
@Override
@Transactional
public Result<JSONObject> save(BrandDTO brandDTO) {

    BrandEntity brandEntity = BeanCopy.copyProperties(brandDTO, BrandEntity.class);
    //处理品牌首字母
    brandEntity.setLetter(PinyinUtil.getUpperCase(String.valueOf(brandEntity.getName().toCharArray()[0]), false).toCharArray()[0]);
    brandMapper.insertSelective(brandEntity);


    this.insertCategoryBrandData(brandDTO.getCategories(),brandEntity.getId());

    return this.setResultSuccess();
}
```

```java
//公用批量增
private void insertCategoryBrandData(String categories,Integer Id){


    if(StringUtils.isEmpty(categories)) throw new RuntimeException("请填写数据");//如果分类集合为空就返回


    List<CategoryBrandEntity> categoryBrandEntities = new ArrayList<>();

    //判断分类集合字符串中是否包含,
    if(categories.contains(",")){//多个分类 --> 批量新增
        String[] categoryArr = categories.split(",");

        for (String s : categoryArr) {
            CategoryBrandEntity categoryBrandEntity = new CategoryBrandEntity();
            categoryBrandEntity.setBrandId(Id);
            categoryBrandEntity.setCategoryId(Integer.valueOf(s));
            categoryBrandEntities.add(categoryBrandEntity);
        }
        //insertListMapper
        categoryBrandMapper.insertList(categoryBrandEntities);
    }else{//普通单个新增

        CategoryBrandEntity categoryBrandEntity = new CategoryBrandEntity();
        categoryBrandEntity.setBrandId(Id);
        categoryBrandEntity.setCategoryId(Integer.valueOf(categories));

        categoryBrandMapper.insertSelective(categoryBrandEntity);
    }

}
```

#### 修改-

```java
@Override
@Transactional
public Result<JSONObject> update(BrandDTO brandDTO) {
    BrandEntity brandEntity = BeanCopy.copyProperties(brandDTO, BrandEntity.class);
    //因为name可能会修改，所以转换大写
    brandEntity.setLetter(PinyinUtil.getUpperCase(String.valueOf(brandEntity.getName().toCharArray()[0]),false).toCharArray()[0]);
    brandMapper.updateByPrimaryKeySelective(brandEntity);

    Example example = new Example(CategoryBrandEntity.class);
    example.createCriteria().andEqualTo("brandId",brandEntity.getId());
    categoryBrandMapper.deleteByExample(example);

    this.insertCategoryBrandData(brandDTO.getCategories(),brandEntity.getId());

    return this.setResultSuccess();
}
```

#### 删除-

```java
@Override
@Transactional
public Result<JSONObject> deleteById(Integer id) {

    brandMapper.deleteByPrimaryKey(id);

    Example example = new Example(CategoryBrandEntity.class);
    example.createCriteria().andEqualTo("brandId",id);
    categoryBrandMapper.deleteByExample(example);

    return this.setResultSuccess();
}
```



# 规格参数模块-流程

## 规格参数(CRUD)

#### 查询

查询接口

```java
@ApiOperation(value = "通过条件查询规格组")
@GetMapping(value="/specGroup/getSepcGroupInfo")
Result<List<SpecGroupEntity>>  getSepcGroupInfo(SpecGroupDTO specGroupDTO);
```

接口实现类

```java
public Result<List<SpecGroupEntity>> getSepcGroupInfo(SpecGroupDTO specGroupDTO) {

    //通过id查询数据
    Example example = new Example(SpecGroupEntity.class);
        example.createCriteria().andEqualTo("cid",
                BaiduBeanUtil.copyProperties(specGroupDTO,SpecGroupEntity.class).getCid());
    List<SpecGroupEntity> list = specGroupMapper.selectByExample(example);
    return this.setResultSuccess(list);
}
```

另外根据组Id查询每个分类的规格参数

接口

```java
@ApiOperation(value = "查询规格参数")
@GetMapping(value = "specparam/getSpecParamInfo")
Result<List<SpecParamEntity>> getSpecParamInfo(SpecParamDTO specParamDTO);
```

实现类

```java
public Result<List<SpecParamEntity>> getSpecParamInfo(SpecParamDTO specParamDTO) {
    Example example = new Example(SpecParamEntity.class);
    example.createCriteria().andEqualTo("groupId",
            BaiduBeanUtil.copyProperties(specParamDTO,SpecParamEntity.class).getGroupId());
    List<SpecParamEntity> list = specParamMapper.selectByExample(example);
    return this.setResultSuccess(list);
}
```

####  新增

tb_spec_params表中的numeric,generic,,searching三个字段代表的含义分别是是否是

numeric:数字类型参数，true或false

generic:是否是sku通用属性，true或false

searching:是否用于搜索过滤，true或false

本身封装实体类这三个字段是Integer类型,需要转换为boolean类型,Entity/DTO都需要更换

numeric是关键字,所有需要特殊处理,加上注解@column来解决

接口

```java
@ApiOperation(value = "新增规格参数")
@PostMapping(value = "specparam/saveSpecParamInfo")
Result<JsonObject> saveSpecParamInfo(@RequestBody SpecParamDTO specParamDTO);
```

实现类

```java
@Transactional
@Override
public Result<JsonObject> saveSpecParamInfo(SpecParamDTO specParamDTO) {
    specParamMapper.insertSelective(BaiduBeanUtil.copyProperties(specParamDTO,SpecParamEntity.class));
    return this.setResultSuccess();
}
```

#### 修改

接口

```java
@ApiOperation(value = "修改规格组")
@PutMapping(value="/specGroup/saveSepcGroupInfo")
Result<JsonObject>  editSepcGroupInfo(@RequestBody SpecGroupDTO specGroupDTO);
```

实现类

```java
@Transactional
@Override
public Result<JsonObject> editSpecParamInfo(SpecParamDTO specParamDTO) {
    specParamMapper.updateByPrimaryKeySelective(BaiduBeanUtil.copyProperties(specParamDTO,SpecParamEntity.class));
    return this.setResultSuccess();
}
```

#### 删除

接口

实现类

```java
@Transactional
@Override
public Result<JsonObject> delSpecParamInfo(Integer id) {

    specParamMapper.deleteByPrimaryKey(id);
    return this.setResultSuccess();
}
```

### FastDFS

 什么是FastDFS：FastDFS是由淘宝的余庆先生所开发的一个轻量级、高性能的开源分布式文件系统。用纯C语言开发， 功能丰富： 文件存储 文件同步 文件访问（上传、下载） 存取负载均衡 在线扩容 适合有大容量存储需求的应用或系统。同类的分布式文件系统有谷歌的GFS、HDFS（Hadoop）、 TFS（淘宝）等。

在liunx下安装fastDFS， 安装Nginx

java上传文件到fastDFS服务

导入依赖com.github.tobato fastdfs-client 1.26.1-RELEASE

配置application.yml

```yml
server:
  port: 8200
spring:
  application:
    name: upload-server
eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka
fdfs:
  so-timeout: 1501
  connect-timeout: 601
  thumb-image: # 缩略图
    width: 60
    height: 60
  tracker-list: # tracker地址
    - 49.232.68.81:22122


mingrui:
  upload:
    path:
      windows: E:\\images
      linux: /util/images
    img:
      host: http://49.232.68.81/

```

service.impl包下新建GoodsServiceImpl

```java
package com.baidu.shop.upload.controller;

import com.baidu.shop.base.Result;
import com.baidu.shop.status.HTTPStatus;
import com.github.tobato.fastdfs.domain.StorePath;
import com.github.tobato.fastdfs.domain.ThumbImageConfig;
import com.github.tobato.fastdfs.service.FastFileStorageClient;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.io.InputStream;

/**
 * @ClassName FastDFSUploadController
 * @Description: TODO
 * @Author wanglonglong
 * @Date 2021/1/5
 * @Version V1.0
 **/
@RestController
@RequestMapping(value = "upload")
@Slf4j
public class FastDFSUploadController {
    //图片服务器的地址
    @Value(value = "${mingrui.upload.img.host}")
    private String imgHost;
    @Autowired
    private FastFileStorageClient storageClient;
    @Autowired
    private ThumbImageConfig thumbImageConfig;


    @PostMapping
    public Result<String> uploadImg(@RequestParam MultipartFile file) throws IOException {
        InputStream inputStream = file.getInputStream();//获取文件输入流
        String filename = file.getOriginalFilename();//文件名
        String ex = filename.substring(filename.lastIndexOf(".") + 1);//文件后缀名
        // 上传并且生成缩略图
        StorePath storePath = this.storageClient.uploadImageAndCrtThumbImage(
                inputStream, file.getSize(), ex, null);//上传
        // 带分组的路径
        log.info("上传图片全路径:{}", storePath.getFullPath());
        // 不带分组的路径
        log.info("上传图片路径:{}", storePath.getPath());
        // 获取缩略图路径
        String path =
                thumbImageConfig.getThumbImagePath(storePath.getFullPath());
        log.info("缩略图路径:{}", path);
        return new Result<String>(HTTPStatus.OK,"上传成功",imgHost + path);
    }

}

```

即可使用postman发送图片 在linux图片目录下查看上传的图片

# 商品列表

#### 查询

接口

```java
@Api(tags = "商品接口")
public interface GoodsService {
    @ApiOperation(value = "查询")
    @GetMapping(value = "goods/getSpuInfo")
    public Result<PageInfo<SpuEntity>> queryGoods(SpuDTO spuDTO);
}
```

实现类

```java
 @Override
    public Result<List<SpuDTO>> queryGoods(SpuDTO spuDTO) {
        if (ObjectUtil.isNotNull(spuDTO.getPage()) && ObjectUtil.isNotNull(spuDTO.getRows()));
        PageHelper.startPage(spuDTO.getPage(),spuDTO.getRows());

        Example example = new Example(SpuEntity.class);

        if (ObjectUtil.isNotNull(spuDTO.getSaleable()) && spuDTO.getSaleable() < 2){
            example.createCriteria().andEqualTo("saleable",spuDTO.getSaleable());
        }
        if(!StringUtils.isEmpty(spuDTO.getSort()) && !StringUtils.isEmpty(spuDTO.getOrder()));
        PageHelper.orderBy(spuDTO.getOrderBy());

        if(!StringUtils.isEmpty(spuDTO.getTitle())) example.createCriteria().andLike("title","%"+spuDTO.getTitle()+"%");

        List<SpuEntity> spuEntities = spuMapper.selectByExample(example);

        List<SpuDTO> collect = spuEntities.stream().map(spuEntity -> {
            SpuDTO spuDTO1 = BeanCopy.copyProperties(spuEntity, SpuDTO.class);


            CategoryEntity categoryEntity = categoryMapper.selectByPrimaryKey(spuDTO1.getCid1());
            CategoryEntity categoryEntity2 = categoryMapper.selectByPrimaryKey(spuDTO1.getCid2());
            CategoryEntity categoryEntity3 = categoryMapper.selectByPrimaryKey(spuDTO1.getCid3());
            spuDTO1.setCategoryName(categoryEntity.getName()+"/"+categoryEntity2.getName()+"/"+categoryEntity3.getName());

//            List<CategoryEntity> categoryEntities = categoryMapper.selectByIdList(Arrays.asList(spuEntity.getCid1(), spuEntity.getCid2(), spuEntity.getCid3()));
//          categoryEntities.stream().map()


            BrandEntity brandEntity = brandMapper.selectByPrimaryKey(spuDTO1.getBrandId());
            spuDTO1.setBrandName(brandEntity.getName());

            return spuDTO1;
        }).collect(Collectors.toList());


        PageInfo<SpuEntity> pageInfo = new PageInfo<>(spuEntities);

        return this.setResult(HTTPStatus.OK,pageInfo.getTotal()+"",collect);
    }
```

#### 新增

接口

```java
@ApiOperation(value = "新增")
@PostMapping(value = "goods/getSpuSave")
Result<JSONObject> saveGoods(@Validated({MingruiOperation.Add.class})@RequestBody SpuDTO spuDTO);
```

实现类

```java
@Override
@Transactional
public Result<JSONObject> saveGoods(SpuDTO spuDTO) {
    final Date date = new Date();
    SpuEntity spuEntity = BeanCopy.copyProperties(spuDTO, SpuEntity.class);
    //新增spu,新增返回主键, 给必要字段赋默认值
    spuEntity.setSaleable(1);
    spuEntity.setValid(1);
    spuEntity.setCreateTime(date);
    spuEntity.setLastUpdateTime(date);
    spuMapper.insertSelective(spuEntity);

    //新增spuDetail 根据Id查询SpuId
    SpuDetailDTO spuDetail = spuDTO.getSpuDetail();
    SpuDetailEntity spuDetailEntity = BeanCopy.copyProperties(spuDetail,SpuDetailEntity.class);
    spuDetailEntity.setSpuId(spuEntity.getId());
    spuDetailMapper.insertSelective(spuDetailEntity);

    //新增sku
    List<SkuDTO> skus = spuDTO.getSkus();

    skus.stream().forEach(skuDTO -> {

        SkuEntity skuEntity = BeanCopy.copyProperties(skuDTO, SkuEntity.class);
        skuEntity.setSpuId(spuEntity.getId());
        skuEntity.setCreateTime(date);
        skuEntity.setLastUpdateTime(date);
        skuMapper.insertSelective(skuEntity);

        //新增stock
        StockEntity stockEntity = new StockEntity();
        stockEntity.setSkuId(skuEntity.getId());
        stockEntity.setStock(skuDTO.getStock());
        stockMapper.insertSelective(stockEntity);
    });

    return this.setResultSuccess();
}
```

#### 修改回显

接口

```java
@ApiOperation(value = "查询品牌")
@GetMapping(value = "goods/spu/detail")
Result<List<SpuEntity>> goodsSpuDetail(Integer spuId);

@ApiOperation(value = "查询库存sku")
@GetMapping(value = "goods/stockandsku/")
Result<List<SpuDTO>> stockandskuList(Integer spuId);
```

实现类

```java
@Override
public Result<List<SpuDTO>> stockandskuList(Integer spuId) {
    List<SkuDTO> list = skuMapper.stockAndSkuList(spuId);
    return this.setResultSuccess(list);
}

@Override
public Result<List<SpuEntity>> goodsSpuDetail(Integer spuId) {
    SpuDetailEntity spuDetailEntity = spuDetailMapper.selectByPrimaryKey(spuId);
    return this.setResultSuccess(spuDetailEntity);
}
```



#### 修改

接口

```java
@ApiOperation(value = "修改")
@PutMapping(value = "goods/getSpuSave")
Result<JSONObject> updateGoods(@Validated({MingruiOperation.Update.class})@RequestBody SpuDTO spuDTO);
```

实现类

```java
@Override
@Transactional
public Result<JSONObject> updateGoods(SpuDTO spuDTO) {
    //spu
    final Date date = new Date();
    SpuEntity spuEntity = BeanCopy.copyProperties(spuDTO, SpuEntity.class);
    spuEntity.setLastUpdateTime(date);
    spuMapper.updateByPrimaryKeySelective(spuEntity);
    //spuDetail
    SpuDetailEntity spuDetailEntity = BeanCopy.copyProperties(spuDTO.getSpuDetail(), SpuDetailEntity.class);
    spuDetailMapper.updateByPrimaryKeySelective(spuDetailEntity);
    //sku
    Example example = new Example(spuEntity.getClass());
    example.createCriteria().andEqualTo("id",spuEntity.getId());
    List<SkuEntity> skuEntities = skuMapper.selectByExample(example);
    List<Long> skuId = skuEntities.stream().map(skuEntity -> skuEntity.getId()).collect(Collectors.toList());
    skuMapper.deleteByIdList(skuId);
    stockMapper.deleteByIdList(skuId);

    //新增sku
    List<SkuDTO> skus = spuDTO.getSkus();

    skus.stream().forEach(skuDTO -> {

        SkuEntity skuEntity = BeanCopy.copyProperties(skuDTO, SkuEntity.class);
        skuEntity.setSpuId(spuEntity.getId());
        skuEntity.setCreateTime(date);
        skuEntity.setLastUpdateTime(date);
        skuMapper.insertSelective(skuEntity);

        //新增stock
        StockEntity stockEntity = new StockEntity();
        stockEntity.setSkuId(skuEntity.getId());
        stockEntity.setStock(skuDTO.getStock());
        stockMapper.insertSelective(stockEntity);
    });
    return this.setResultSuccess();
}
```

#### 删除

接口

```java
@ApiOperation(value = "删除")
@DeleteMapping(value = "GoodsDeletes")
Result<JSONObject> GoodsDeletes(Integer pId);
```

实现类

```java
@Override
@Transactional
public Result<JSONObject> GoodsDeletes(Integer pId) {

    spuMapper.deleteByPrimaryKey(pId);

    spuDetailMapper.deleteByPrimaryKey(pId);


    //sku
    Example example = new Example(SpuEntity.class);
    example.createCriteria().andEqualTo("id",pId);
    List<SkuEntity> skuEntities = skuMapper.selectByExample(example);
    List<Long> skuId = skuEntities.stream().map(skuEntity -> skuEntity.getId()).collect(Collectors.toList());
    skuMapper.deleteByIdList(skuId);
    stockMapper.deleteByIdList(skuId);

    return this.setResultSuccess();
}
```

#### 上下架

接口

```java
@ApiOperation(value = "上下架")
@PutMapping(value = "goods/updateSaleable")
Result<JSONObject> updateSaleable(@Validated({MingruiOperation.Update.class})@RequestBody SpuDTO spuDTO);
```

实现类

```java
@Override
@Transactional
public Result<JSONObject> updateSaleable(SpuDTO spuDTO) {

    SpuEntity spuEntity = BeanCopy.copyProperties(spuDTO, SpuEntity.class);

    if (spuEntity.getSaleable()==1){
        spuEntity.setSaleable(0);
    }else{
        spuEntity.setSaleable(1);
    }

    spuMapper.updateByPrimaryKeySelective(spuEntity);

    return this.setResultSuccess();
}
```

